<?php

namespace RESTAPI\Models;

use RESTAPI\Core\Model;
use RESTAPI\Fields\Base64Field;
use RESTAPI\Fields\ForeignModelField;
use RESTAPI\Fields\IntegerField;
use RESTAPI\Fields\StringField;
use RESTAPI\Fields\UIDField;
use RESTAPI\Validators\RegexValidator;

class CertificateRevocationList extends Model
{
    public UIDField $refid;
    public StringField $descr;
    public ForeignModelField $caref;
    public StringField $method;
    public IntegerField $lifetime;
    public IntegerField $serial;
    public Base64Field $text;

    public function __construct(mixed $id = null, mixed $parent_id = null, mixed $data = [], ...$options)
    {
        # Set model attributes
        $this->config_path = "crl";
        $this->many = true;
        $this->always_apply = true;
        
        # Set model fields
        $this->refid = new UIDField(
            help_text: "The unique ID for this CRL. This is automatically generated by the ".
                "system and cannot be changed."
        );
        $this->descr = new StringField(
            required: true,
            unique: true,
            editable: false,
            validators: [new RegexValidator(pattern: "/[\?\>\<\&\/\\\"\']/", invert: true)],
            help_text: "The unique name/description for this CRL."
        );
        $this->caref = new ForeignModelField(
            model_name: "CertificateAuthority",
            model_field: "refid",
            required: true,
            editable: false,
            help_text: "The unique ID of the CA that this CRL is associated with."
        );
        $this->method = new StringField(
            required: true,
            choices: ["existing", "internal"],
            editable: false,
            help_text: "The method used to generate this CRL."
        );
        $this->lifetime = new IntegerField(
            default: 730,
            editable: false,
            minimum: 1,
            maximum: 8381,
            conditions: ["method" => "internal"],
            help_text: "The lifetime of this CRL in days."
        );
        $this->serial = new IntegerField(
            default: 0,
            editable: false,
            conditions: ["method" => "internal"],
            help_text: "The serial number of the CRL."
        );
        $this->text = new Base64Field(
            required: true,
            editable: false,
            conditions: ["method" => "existing"],
            help_text: "The raw x509 CRL data."
        );
        
        parent::__construct($id, $parent_id, $data, ...$options);
    }
    
    /**
     * Applies the newly created CRL by reloading the OpenVPN and IPsec services.
     */
    public function apply(): void
    {
        openvpn_refresh_crls();
        ipsec_configure();
    }

}
